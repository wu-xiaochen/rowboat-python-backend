# HAProxy Configuration for Rowboat Production Deployment
# Advanced load balancing with SSL termination and health checks

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # SSL Configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Performance tuning
    maxconn 50000
    hard-stop-after 10s
    ulimit-n 1048576
    tune.ssl.default-dh-param 2048
    spread-checks 5

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option httpchk
    retries 3
    timeout connect 5s
    timeout check 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 2s
    timeout tunnel 3600s
    maxconn 3000
    default-server init-addr none

# HTTP to HTTPS redirect
frontend http_frontend
    bind *:80
    bind :::80

    # Security headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    http-response set-header X-Robots-Tag "noindex, nofollow"
    http-response set-header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' wss:; media-src 'self';"

    # Redirect HTTP to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

# HTTPS Frontend with SSL termination
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/your-domain.com.pem alpn h2,http/1.1
    bind :::443 ssl crt /etc/ssl/certs/your-domain.com.pem alpn h2,http/1.1

    # HTTP/2 support
    http-response set-header Alt-Svc "h2=\":443\"; ma=60"

    # CORS headers for API
    http-response set-header Access-Control-Allow-Origin "https://your-domain.com"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "authorization, content-type, x-requested-with"
    http-response set-header Access-Control-Allow-Credentials "true"
    http-response set-header Access-Control-Max-Age "86400"

    # Rate limiting headers
    stick-table type ip size 200k expire 10m store conn_cur(3),conn_rate(3s),http_req_rate(10s)
    http-request set-header X-Forwarded-For src
    declare capture request len 32
    declare capture response len 32

    # Bot detection and blocking
    acl bad_bot hdr_sub(User-Agent) -i \
        bot ahrefsbot semrushbot dotbot mj12bot wget curl \
        nmap nessus sqlmap dirbuster gobuster burp
    http-request deny if bad_bot

    # SQL injection protection
    acl sql_injection \
        url_reg -i \
            (union|select|insert|update|delete|drop|create|alter|exec|script|javascript|vbscript|onerror|onload)
    http-request deny if sql_injection

    # XSS protection
    acl xss_attack \
        url_sub &lt;script \
        url_sub &gt; \
        url_sub &quot; \
        url_sub javascript:
    http-request deny if xss_attack

    # Static file serving (if needed)
    acl is_static path_end .css .js .png .jpg .jpeg .gif .ico .svg .woff .woff2 .ttf .eot
    acl is_api path_beg /api/
    acl is_health path /health
    acl is_metrics path /metrics
    acl is_docs path_beg /docs
    acl is_monitor path_beg /monitor

    # API-specific rate limiting
    http-request track-sc0 src if is_api
    http-request track-sc0 src if is_health
    http-request track-sc0 src if is_metrics

    # Connection limits per IP
    http-request deny if { sc0_conn_rate(3s) gt 30 }
    http-request deny if { sc0_conn_cur gt 50 }
    http-request deny if { sc0_http_req_rate(10s) gt 300 }

    # Authentication bypass for health/doc endpoints
    use_backend appservers if is_health
    use_backend appservers if is_docs
    use_backend appservers if is_metrics

    # Default backend
    use_backend appservers

# Application servers backend
backend appservers
    balance leastconn
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost\r\n
    # Health check configuration
    default-server check inter 5s rise 2 fall 3 maxconn 100

    # Session persistence
    cookie SERVER insert indirect nocache

    # First server
    server app1 rowboat-backend-1:8000 cookie app1 weight 10 maxconn 200 \
        ssl verify none check-ssl ca-file /etc/ssl/certs/ca.crt \
        check port 8000 inter 5s observe layer7 error-limit 10 on-error mark-down

    # Second server
    server app2 rowboat-backend-2:8000 cookie app2 weight 10 maxconn 200 \
        ssl verify none check-ssl ca-file /etc/ssl/certs/ca.crt \
        check port 8000 inter 5s observe layer7 error-limit 10 on-error mark-down

    # Third server
    server app3 rowboat-backend-3:8000 cookie app3 weight 10 maxconn 200 \
        ssl verify none check-ssl ca-file /etc/ssl/certs/ca.crt \
        check port 8000 inter 5s observe layer7 error-limit 10 on-error mark-down

    # Retry configuration
    retries 3
    retry-on all-retryable-errors

# WebSocket backend for real-time features
backend ws_backend
    balance leastconn
    option httpchk
    default-server check inter 5s rise 2 fall 3 maxconn 50

    server ws1 rowboat-backend-1:8000 weight 10 maxconn 100 check
    server ws2 rowboat-backend-2:8000 weight 10 maxconn 100 check
    server ws3 rowboat-backend-3:8000 weight 10 maxconn 100 check

    timeout server 3600s
    timeout tunnel 3600s

# Statistics backend
listen stats
    bind *:8404 ssl crt /etc/ssl/certs/your-domain.com.pem
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats show-desc "Rowboat Production Load Balancer Statistics"
    stats show-legends
    stats auth admin:${STATS_PASSWORD}

    # Additional stats options
    stats show-modules
    stats show-node
    stats hide-version

# Error handling for maintenance mode
errorfile 400 /etc/haproxy/errors/400.http
errorfile 403 /etc/haproxy/errors/403.http
errorfile 408 /etc/haproxy/errors/408.http
errorfile 500 /etc/haproxy/errors/500.http
errorfile 502 /etc/haproxy/errors/502.http
errorfile 503 /etc/haproxy/errors/503.http
errorfile 504 /etc/haproxy/errors/504.http

# Maintenance backend (when servers are down)
backend maintenance
    mode http
    errorfile 503 /etc/haproxy/errors/maintenance.http